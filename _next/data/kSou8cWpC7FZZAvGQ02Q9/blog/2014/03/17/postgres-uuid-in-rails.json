{"pageProps":{"article":{"title":"Postgres UUID in Rails","slug":["2014","03","17","postgres-uuid-in-rails"],"uri":"2014/03/17/postgres-uuid-in-rails","date":"2014/03/17","content":"var Component=(()=>{var o=Object.create;var r=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var p=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var g=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),y=(n,e)=>{for(var a in e)r(n,a,{get:e[a],enumerable:!0})},i=(n,e,a,c)=>{if(e&&typeof e==\"object\"||typeof e==\"function\")for(let l of p(e))!j.call(n,l)&&l!==a&&r(n,l,{get:()=>e[l],enumerable:!(c=m(e,l))||c.enumerable});return n};var N=(n,e,a)=>(a=n!=null?o(u(n)):{},i(e||!n||!n.__esModule?r(a,\"default\",{value:n,enumerable:!0}):a,n)),_=n=>i(r({},\"__esModule\",{value:!0}),n);var t=g((x,d)=>{d.exports=_jsx_runtime});var k={};y(k,{default:()=>w,frontmatter:()=>b});var s=N(t()),b={layout:\"post\",title:\"Postgres UUID in Rails\",date:\"2014-03-17\",comments:!0,categories:[\"postgresql\",\"rails\"]};function h(n){let e=Object.assign({h1:\"h1\",p:\"p\",a:\"a\",pre:\"pre\",code:\"code\",span:\"span\",strong:\"strong\"},n.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{children:\"Intro & Setup\"}),`\n`,(0,s.jsxs)(e.p,{children:[\"Rails 4 has native support for \",(0,s.jsx)(e.a,{href:\"http://en.wikipedia.org/wiki/Universally_unique_identifier\",children:\"UUID\"}),\" in PostgreSQL so I decided to give it a try in my test project.\"]}),`\n`,(0,s.jsx)(e.p,{children:\"First, you need to enable PostgreSQL extension 'uuid-ossp'. Create a new migration like this:\"}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-bash\",children:`rails generate migration enable_uuid_ossp\n`})}),`\n`,(0,s.jsx)(e.p,{children:\"And edit the newly created migration file\"}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"class\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"EnableUuidOssp\"}),\" < \",(0,s.jsx)(e.span,{className:\"hljs-title class_ inherited__\",children:\"ActiveRecord::Migration\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"def\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"change\"}),`\n    enable_extension `,(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'uuid-ossp'\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`]})}),`\n`,(0,s.jsxs)(e.p,{children:[\"After that, run \",(0,s.jsx)(e.code,{children:\"rake db:migrate\"}),\". After this, you can use start using \",(0,s.jsx)(e.code,{children:\":uuid\"}),\" as your table's primary key in other migrations. For example:\"]}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:\"hljs language-ruby\",children:`rails generate migration create_users\n`})}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"class\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"CreateUsers\"}),\" < \",(0,s.jsx)(e.span,{className:\"hljs-title class_ inherited__\",children:\"ActiveRecord::Migration\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"def\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"change\"}),`\n   create_table `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":users\"}),\", \",(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\"id:\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":uuid\"}),\"  \",(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"do\"}),\" |\",(0,s.jsx)(e.span,{className:\"hljs-params\",children:\"t\"}),`|\n      t.string `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":username\"}),`\n      t.string `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":fullname\"}),`\n      t.string `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":email\"}),`\n      t.string `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":encrypted_password\"}),`\n      t.timestamps\n    `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`]})}),`\n`,(0,s.jsxs)(e.p,{children:[\"You can also use \",(0,s.jsx)(e.code,{children:\":uuid\"}),\" not as ID replacement but on a specific column\"]}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"class\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"AddSuperIdToStudents\"}),\" < \",(0,s.jsx)(e.span,{className:\"hljs-title class_ inherited__\",children:\"ActiveRecord::Migration\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"def\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title function_\",children:\"change\"}),`\n    add_column `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":students\"}),\", \",(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":super_id\"}),\", \",(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":uuid\"}),`\n  `,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`]})}),`\n`,(0,s.jsx)(e.h1,{children:\"Drawbacks\"}),`\n`,(0,s.jsxs)(e.p,{children:[\"Using UUID as ID replacement will make \",(0,s.jsx)(e.code,{children:\"Model.first\"}),\" and \",(0,s.jsx)(e.code,{children:\"Model.last\"}),\" methods not working anymore (UUID is all about randomness after all). Luckily, you can use \",(0,s.jsx)(e.code,{children:\"created_at\"}),\" attribute and implement \",(0,s.jsx)(e.code,{children:\"default_scope\"}),\" in your model as following:\"]}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"class\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"User\"}),\" < \",(0,s.jsx)(e.span,{className:\"hljs-title class_ inherited__\",children:\"ActiveRecord::Base\"}),`\n  default_scope -> { order(`,(0,s.jsx)(e.span,{className:\"hljs-string\",children:\"'created_at ASC'\"}),`) }\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`]})}),`\n`,(0,s.jsxs)(e.p,{children:[\"Or you can define you own scopes using \",(0,s.jsx)(e.code,{children:\"created_at\"}),\":\"]}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"class\"}),\" \",(0,s.jsx)(e.span,{className:\"hljs-title class_\",children:\"User\"}),\" < \",(0,s.jsx)(e.span,{className:\"hljs-title class_ inherited__\",children:\"ActiveRecord::Base\"}),`\n  scope `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":first\"}),\", -> { order(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"created_at\"'}),`).first }\n  scope `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":last\"}),\", -> { order(\",(0,s.jsx)(e.span,{className:\"hljs-string\",children:'\"created_at DESC\"'}),`).first }\n`,(0,s.jsx)(e.span,{className:\"hljs-keyword\",children:\"end\"}),`\n`]})}),`\n`,(0,s.jsxs)(e.p,{children:[\"Another problem is that \",(0,s.jsx)(e.code,{children:\"t.references\"}),\" method in your migrations. If your \",(0,s.jsx)(e.strong,{children:\"users\"}),\" table have UUID as ID and you define reference to it in other tables using \",(0,s.jsx)(e.code,{children:\"t.references :user\"}),\", it will create a \",(0,s.jsx)(e.code,{children:\"user_id\"}),\" column with \",(0,s.jsx)(e.code,{children:\"integer\"}),\" as the type in those tables. Of course, it's not going to work. You must specifically define the reference like this:\"]}),`\n`,(0,s.jsx)(e.pre,{children:(0,s.jsxs)(e.code,{className:\"hljs language-ruby\",children:[`...\nt.uuid `,(0,s.jsx)(e.span,{className:\"hljs-symbol\",children:\":user_id\"}),`\n...\n`]})})]})}function f(n={}){let{wrapper:e}=n.components||{};return e?(0,s.jsx)(e,Object.assign({},n,{children:(0,s.jsx)(h,n)})):h(n)}var w=f;return _(k);})();\n;return Component;"}},"__N_SSG":true}