{"pageProps":{"article":{"title":"Postgres UUID in Rails","slug":["2014","03","17","postgres-uuid-in-rails"],"uri":"2014/03/17/postgres-uuid-in-rails","updatedTime":"2014/03/17","content":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    p: \"p\",\n    a: \"a\",\n    pre: \"pre\",\n    code: \"code\",\n    span: \"span\",\n    strong: \"strong\"\n  }, props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"Intro & Setup\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Rails 4 has native support for \", _jsx(_components.a, {\n        href: \"http://en.wikipedia.org/wiki/Universally_unique_identifier\",\n        children: \"UUID\"\n      }), \" in PostgreSQL so I decided to give it a try in my test project.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"First, you need to enable PostgreSQL extension 'uuid-ossp'. Create a new migration like this:\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-bash\",\n        children: \"rails generate migration enable_uuid_ossp\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"And edit the newly created migration file\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"EnableUuidOssp\"\n        }), \" < \", _jsx(_components.span, {\n          className: \"hljs-title class_ inherited__\",\n          children: \"ActiveRecord::Migration\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"def\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"change\"\n        }), \"\\n    enable_extension \", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"'uuid-ossp'\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"After that, run \", _jsx(_components.code, {\n        children: \"rake db:migrate\"\n      }), \". After this, you can use start using \", _jsx(_components.code, {\n        children: \":uuid\"\n      }), \" as your table's primary key in other migrations. For example:\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"hljs language-ruby\",\n        children: \"rails generate migration create_users\\n\"\n      })\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"CreateUsers\"\n        }), \" < \", _jsx(_components.span, {\n          className: \"hljs-title class_ inherited__\",\n          children: \"ActiveRecord::Migration\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"def\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"change\"\n        }), \"\\n   create_table \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":users\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \"id:\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":uuid\"\n        }), \"  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"do\"\n        }), \" |\", _jsx(_components.span, {\n          className: \"hljs-params\",\n          children: \"t\"\n        }), \"|\\n      t.string \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":username\"\n        }), \"\\n      t.string \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":fullname\"\n        }), \"\\n      t.string \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":email\"\n        }), \"\\n      t.string \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":encrypted_password\"\n        }), \"\\n      t.timestamps\\n    \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"You can also use \", _jsx(_components.code, {\n        children: \":uuid\"\n      }), \" not as ID replacement but on a specific column\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"AddSuperIdToStudents\"\n        }), \" < \", _jsx(_components.span, {\n          className: \"hljs-title class_ inherited__\",\n          children: \"ActiveRecord::Migration\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"def\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title function_\",\n          children: \"change\"\n        }), \"\\n    add_column \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":students\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":super_id\"\n        }), \", \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":uuid\"\n        }), \"\\n  \", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"Drawbacks\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Using UUID as ID replacement will make \", _jsx(_components.code, {\n        children: \"Model.first\"\n      }), \" and \", _jsx(_components.code, {\n        children: \"Model.last\"\n      }), \" methods not working anymore (UUID is all about randomness after all). Luckily, you can use \", _jsx(_components.code, {\n        children: \"created_at\"\n      }), \" attribute and implement \", _jsx(_components.code, {\n        children: \"default_scope\"\n      }), \" in your model as following:\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"User\"\n        }), \" < \", _jsx(_components.span, {\n          className: \"hljs-title class_ inherited__\",\n          children: \"ActiveRecord::Base\"\n        }), \"\\n  default_scope -> { order(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"'created_at ASC'\"\n        }), \") }\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Or you can define you own scopes using \", _jsx(_components.code, {\n        children: \"created_at\"\n      }), \":\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [_jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"class\"\n        }), \" \", _jsx(_components.span, {\n          className: \"hljs-title class_\",\n          children: \"User\"\n        }), \" < \", _jsx(_components.span, {\n          className: \"hljs-title class_ inherited__\",\n          children: \"ActiveRecord::Base\"\n        }), \"\\n  scope \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":first\"\n        }), \", -> { order(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"created_at\\\"\"\n        }), \").first }\\n  scope \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":last\"\n        }), \", -> { order(\", _jsx(_components.span, {\n          className: \"hljs-string\",\n          children: \"\\\"created_at DESC\\\"\"\n        }), \").first }\\n\", _jsx(_components.span, {\n          className: \"hljs-keyword\",\n          children: \"end\"\n        }), \"\\n\"]\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Another problem is that \", _jsx(_components.code, {\n        children: \"t.references\"\n      }), \" method in your migrations. If your \", _jsx(_components.strong, {\n        children: \"users\"\n      }), \" table have UUID as ID and you define reference to it in other tables using \", _jsx(_components.code, {\n        children: \"t.references :user\"\n      }), \", it will create a \", _jsx(_components.code, {\n        children: \"user_id\"\n      }), \" column with \", _jsx(_components.code, {\n        children: \"integer\"\n      }), \" as the type in those tables. Of course, it's not going to work. You must specifically define the reference like this:\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsxs(_components.code, {\n        className: \"hljs language-ruby\",\n        children: [\"...\\nt.uuid \", _jsx(_components.span, {\n          className: \"hljs-symbol\",\n          children: \":user_id\"\n        }), \"\\n...\\n\"]\n      })\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = props.components || ({});\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n"}},"__N_SSG":true}