name: Auto Deploy

# Run when there is comment created
on:
  issue_comment:
    types: [ created ]

jobs:
  get_inputs:
    runs-on: ubuntu-latest
    # only run when this is a comment on PR 
    if: ${{ github.event.issue.pull_request }}
    name: PR comment to Deploy
    outputs:
      env: ${{ steps.check_command.outputs.env }}
      branch: ${{ steps.get_branch_name.outputs.branch_name }}
    steps:
      - name: Check deploy command
        uses: actions/github-script@v6
        id: check_command
        with:
          script: |
            const { owner, repo } = context.repo;
            const body = context.payload.comment.body
            let [command, env] = body.split(' ').filter(w => w !== '')
            if (command !== '/deploy') {
              // Not deploy comment, abort other steps
              core.setFailed('Invalid command')
              return;
            }
            if (!['qa1', 'qa2', 'qa3'].includes(env)) {
              core.setFailed('Invalid environment')
              return;
            }
            core.info(`Prepare to deploy to: ${env}`)
            core.setOutput('to_deploy', 'true')
            core.setOutput('env', env)
            await github.rest.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
      - name: Get branch name
        uses: actions/github-script@v6
        id: get_branch_name
        if: ${{ steps.check_command.outputs.to_deploy == 'true' }}
        with:
          script: |
            const request = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            }
            core.info(`Getting PR #${request.pull_number} from ${request.owner}/${request.repo}`)
            try {
              const result = await github.rest.pulls.get(request)
              const branchName = result.data.head.ref
              core.info(`Branch to deploy: ${branchName}`)
              core.setOutput('branch_name', branchName)
            } catch (err) {
              core.setFailed(`Request failed with error ${err}`)
            }

  notify-start:
    uses: linhmtran168/linhmtran168.github.io/.github/workflows/slack_notify_start.yml@master
    needs: get_inputs
    with:
      params: "Branch: ${{ needs.get_inputs.outputs.branch }}, Environment: ${{ needs.get_inputs.outputs.env }}"
    secrets: inherit

  deploy:
    uses: linhmtran168/linhmtran168.github.io/.github/workflows/deploy_test.yml@master
    needs: notify-start
    name: Deploy
    with:
      branch: ${{ needs.get_inputs.outputs.branch }}
      environment: ${{ needs.get_inputs.outputs.env }}
    secrets: inherit

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    name: Notify
    steps:
      - name: Create reaction comment
        uses: actions/github-script@v6
        id: check_command
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
